# block B: passive observe (watch + await)

> see what the clone does without interrupt. stream output to terminal. pipe output to files. ctrl+c returns to shell, clone continues.

---

## read first

1. `./1.vision.md` — sections: "operation: watch", "operation: ask/act" (--watch, --await flags), "output legend"
2. `./2.1.criteria.blackbox.md` — usecases 4 (observe: watch) and 5 (block output: await)
3. `./3.3.blueprint.v1.i1.md` — codepath 2.4 (observation modes: invokeWatch, setTerminalToWatchClone, setTerminalToAwaitTask)
4. `./3.3.blueprint.z1.ipc-message.v1.i1.md` — IPC message types: attach, detach, output, task-complete
5. `./3.5.decomposition.v1.i1.md` — block B section: what ships, boundaries, file count

---

## prerequisite

**block A must be complete.** the daemon, IPC, hero clone dispatch, and `khlone act`/`khlone ask` must work. this block extends them with observation.

---

## scope

### what to build

**domain operations (3 prod, 3 test):**
- setTerminalToWatchClone — connect to daemon, pipe clone output to terminal stdout
- setTerminalToDetach — disconnect output pipe, return terminal to shell
- setTerminalToAwaitTask — connect, block until task-complete, emit output, detach

**IPC messages to add:**
- `attach` — cli → daemon: start output pipe for a clone
- `detach` — cli → daemon: stop output pipe
- `output` — daemon → cli: raw clone output bytes (streamed)
- `task-complete` (extended) — daemon → cli: task done, final output included

**cli (1 prod):**
- invokeWatch — `khlone watch` command
- extend invokeAsk/invokeAct with `--watch` and `--await` flags

**acceptance (2 tests):**
- khlone.watch — stream output, ctrl+c returns, clone continues
- khlone.await — block until done, output emits to stdout, pipe to file works

### what NOT to build

- **no interactive input.** watch is passive — output only. talk mode deferred to block E.
- **no `--who` flag on watch.** hero clone only (multi-clone comes in block D).
- **no transcript persistence.** output streams to terminal live, not saved to disk (block F).

---

## file count

| layer | prod | test | total |
|-------|------|------|-------|
| domain.operations (observe) | 3 | 3 | 6 |
| contract/cli (watch + flag updates) | 1 | 0 | 1 |
| acceptance | 0 | 2 | 2 |
| **total** | **4** | **5** | **9** |

---

## usecases fulfilled

| usecase | status |
|---------|--------|
| usecase.4: observe (watch) | **yes** — stream output, ctrl+c returns, clone unaffected |
| usecase.5: block output (await) | **yes** — block until done, pipe to file via stdout |

---

## playtests

```sh
$ khlone act "implement auth" --watch
✓ task-abc-123 → foreman.1 (@feat/auth)

lets watch...

             ┬
● foreman.1  │ read src/auth.ts
● foreman.1  │ edit: add jwt validation
^C
$ _                              # ctrl+c, back to shell. clone continues.

$ khlone ask "summarize changes" --await >> summary.md
# blocks until done, output captured in file
```

---

## done when

- [ ] `khlone watch` streams clone output to terminal
- [ ] ctrl+c amid watch returns to shell; clone continues unaffected
- [ ] `khlone act "prompt" --watch` dispatches then streams
- [ ] `khlone ask "prompt" --await` blocks until task completes, emits output to stdout
- [ ] `khlone ask "prompt" --await >> file.md` captures output in file via shell redirect
- [ ] IPC attach/detach/output messages work end-to-end
- [ ] acceptance test: watch → see output → ctrl+c → verify clone still active
- [ ] acceptance test: await → block → verify output captured
