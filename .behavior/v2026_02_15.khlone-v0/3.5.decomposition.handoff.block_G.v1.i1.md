# block G: cross-scope (--zone, --site)

> reach into other zones and sites from anywhere. the orchestrator registry makes cross-scope address work. full `khlone list` and smart status defaults arrive here.

---

## read first

1. `./1.vision.md` — sections: "domain model > hierarchy" (orchestrator → site → zone), "domain model > site" (khlone.yml, slug), "domain operations > list" (scopes: sites, zones, crews, tasks), "domain operations > status" (smart defaults), "cross-scope dispatch" (--zone, --site, zone address formats), "flags reference > scope flags"
2. `./2.1.criteria.blackbox.md` — usecases 6 (status — full: smart defaults based on pwd), 7 (resource enumeration: list sites/zones/crews/tasks), 10 (cross-zone dispatch), 11 (cross-site dispatch)
3. `./3.3.blueprint.v1.i1.md` — codepath 2.5 (status + list), section 4.2 (how subdomains compose for each usecase), section 3.3 (dao contracts: daoOrchestrator, daoSite)
4. `./3.2.distill.domain._.v1.i1.md` — domain objects: Orchestrator, Site; operations: orchestrator/, site/, zone/ (cross-scope lookups), status/ (smart defaults)
5. `./3.5.decomposition.v1.i1.md` — block G section: what ships, boundaries, file count

---

## prerequisite

**blocks A and F must be complete.** the daemon + IPC + dispatch must work (A), and persistence must exist (F). cross-scope address relies on the orchestrator registry and site DAOs — both require the persistence layer.

---

## scope

### what to build

**domain objects (2 files):**
- Orchestrator — global state across machine: `~/.khlone/`, site registry
- Site — repo-level container: slug (`org/repo`), config ref, path to gitroot

**access/daos (2 files):**
- daoOrchestrator — global registry: `~/.khlone/orchestrator.json`, site refs
- daoSite — site registry: `~/.khlone/sites/{slug}/site.json`

**domain operations (13 prod, 13 test):**

orchestrator operations:
- genOrchestrator — load or init `~/.khlone/` directory and orchestrator state
- setSite — register a site in the orchestrator registry
- getOneSiteBySlug — find site by slug in the orchestrator
- getAllSites — enumerate all sites on the machine

site operations:
- getOneSite — load site from gitroot (parse khlone.yml + path)
- genSite — find in orchestrator or load + register
- getAllZonesForSite — enumerate all zones for a site from the DAO layer

zone operations (DAO-backed):
- genZone — find extant zone in persistence or create new (bind worktree, persist via daoZone)
- setZone — persist zone state to disk
- getOneZoneByAddress — cross-zone lookup: parse address → find zone in site
- getAllClonesForZone — DAO-backed clone enumeration (reads from daoClone)
- getAllTasksForZone — DAO-backed task enumeration (reads from daoTask)

status operations:
- getOneStatusSite — site-level status: aggregate all zones
- getOneStatusOrchestrator — orchestrator-level status: aggregate all sites
- getOneStatusScope — smart default: pwd in feature branch → zone, pwd in main → site, pwd outside git → orchestrator

**cli (1 prod — new file + extend extant):**
- invokeList — `khlone list sites|zones|crews|tasks` command
- extend invokeStatus with smart scope defaults and `--site`, `--zone` support

**acceptance (4 tests):**
- khlone.crosszone — `--zone @feat/invoice` dispatches to different zone, zone auto-created if absent
- khlone.crosssite — `--site ahbode/svc-jobs` dispatches to different repo
- khlone.list — `khlone list sites|zones|crews|tasks` renders correct tree output
- khlone.status — smart defaults: feature branch → zone, main → site, outside git → orchestrator

### zone address formats

```
@branch                    # current site, target branch
repo@branch                # same org, different repo
org/repo@branch            # full address
```

cross-zone dispatch to a zone that does not yet exist auto-creates the zone (init + enroll hero).

### orchestrator filesystem layout

```
~/.khlone/
├── orchestrator.json              # global config + site registry
└── sites/
    ├── ehmpathy--myrepo/
    │   ├── site.json
    │   └── zones/
    │       ├── feat--auth/        # (from block F)
    │       └── main/
    └── ahbode--svc-jobs/
        ├── site.json
        └── zones/
            └── feat--invoice/
```

### what NOT to build

- **all v0 behavior is complete after this block.** no deferred capabilities remain.

---

## file count

| layer | prod | test | total |
|-------|------|------|-------|
| domain.objects (2: orchestrator, site) | 2 | 0 | 2 |
| access/daos (2: orchestrator, site) | 2 | 0 | 2 |
| domain.operations (orchestrator, site, zone, status) | 13 | 13 | 26 |
| contract/cli (list + status smart defaults) | 1 | 0 | 1 |
| acceptance (crosszone, crosssite, list, status-full) | 0 | 4 | 4 |
| **total** | **18** | **17** | **35** |

---

## usecases fulfilled

| usecase | status |
|---------|--------|
| usecase.6: status (full) | **yes** — smart defaults based on pwd context |
| usecase.7: resource enumeration | **yes** — list sites, zones, crews, tasks |
| usecase.10: cross-zone dispatch | **yes** — `--zone` dispatches to different branch |
| usecase.11: cross-site dispatch | **yes** — `--site` dispatches to different repo |

---

## playtests

```sh
# cross-zone dispatch from @main
$ khlone act "fix bug" --zone @hotfix/typo
✓ init @hotfix/typo → foreman.1
✓ task-stu-901 → foreman.1 (@hotfix/typo)

# cross-site dispatch
$ khlone ask "how does auth work" --zone svc-auth@main --await >> notes.md
# dispatches to svc-auth site, main zone

# list zones in current site
$ khlone list zones
site ehmpathy/myrepo
├─ @main          ○ foreman.1
├─ @feat/auth     ● foreman.1 (67%), ○ researcher.1
└─ @hotfix/typo   ✓ foreman.1

# list all sites on machine
$ khlone list sites
orchestrator ~/.khlone/
├─ ehmpathy/myrepo       2 zones │ ●3 active
└─ ahbode/svc-jobs       1 zone  │ ○ idle

# smart status defaults
$ khlone status                  # on feature branch → zone scope
zone @feat/auth (local)
├─ ● foreman.1  67%  implement auth
└─ queue 2 tasks

$ khlone status                  # on main branch → site scope
site ehmpathy/myrepo
├─ @main          ○ foreman.1
└─ @feat/auth     ● foreman.1 (67%)

$ khlone status --site ahbode/svc-jobs   # explicit cross-site
site ahbode/svc-jobs
├─ @main          ○ foreman.1
└─ @feat/invoice  ● foreman.1 (45%)
```

---

## done when

- [ ] `~/.khlone/` directory and orchestrator state auto-created on first use
- [ ] site registration: genSite registers in orchestrator, persists to daoSite
- [ ] getAllSites enumerates all sites from orchestrator registry
- [ ] `--zone @hotfix/typo` dispatches to different zone (auto-creates if absent)
- [ ] `--zone svc-auth@main` dispatches to different site + zone
- [ ] `--site ahbode/svc-jobs` queries a different site
- [ ] `khlone list sites` shows all sites with zone counts and activity
- [ ] `khlone list zones` shows all zones in current site with clone status
- [ ] `khlone list crews` shows all clones in current zone with role, brain, status
- [ ] `khlone list tasks` shows all tasks in current zone with mode, status, clone, tokens
- [ ] `khlone status` smart defaults: feature branch → zone, main → site, outside git → orchestrator
- [ ] acceptance test: cross-zone dispatch + auto-create zone
- [ ] acceptance test: cross-site dispatch
- [ ] acceptance test: list renders correct tree for all scopes
- [ ] acceptance test: smart status defaults select correct scope
