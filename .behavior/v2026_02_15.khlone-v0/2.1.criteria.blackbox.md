# khlone v0: blackbox criteria

> experience boundaries for site orchestration

---

## usecase.1 = instant dispatch

```
given(user in a git worktree with khlone.yml)
  when(user runs `khlone act "implement auth"`)
    then(shell returns immediately)
      sothat(user can continue other work)
    then(output shows task queued to hero clone)
    then(output shows zone context)
    then(task mode is act)

  when(user runs `khlone ask "what changed?"`)
    then(shell returns immediately)
    then(output shows task queued to hero clone)
    then(task mode is ask)

given(user in a git worktree without prior init)
  when(user runs `khlone act "first task"`)
    then(zone is auto-initialized)
    then(hero clone is enrolled)
    then(task is queued)
    then(shell returns immediately)
      sothat(explicit init is never required)
```

## usecase.2 = task mode enforcement

> ask = readonly (no side effects). act = readwrite (modifies files/state).

```
given(clone is active on an ask task)
  when(clone attempts to modify a file)
    then(modification is denied)
      sothat(ask tasks have no side effects)
  when(clone reads files and reasons about them)
    then(read is permitted)
    then(clone responds with answer)

given(clone is active on an act task)
  when(clone attempts to modify a file)
    then(modification is permitted)
  when(clone reads files and reasons about them)
    then(read is permitted)

given(user wants an answer piped to file)
  when(user runs `khlone ask "summarize changes" --await >> summary.md`)
    then(task mode is ask)
    then(clone reads, reasons, responds)
    then(response emits to stdout and captures in file)
      sothat(ask + --await = safe query with shell-native output)

given(user wants an action piped to file)
  when(user runs `khlone act "generate changelog" --await >> changelog.md`)
    then(task mode is act)
    then(clone acts, then emits final output to stdout)
```

## usecase.3 = queue stack

```
given(hero clone is active on a task)
  when(user runs `khlone act "second task"`)
    then(task is added to queue)
    then(shell returns immediately)
    then(output shows task queued)
      sothat(user can stack multiple tasks without wait)

  when(user runs `khlone act "urgent fix" --prioritize`)
    then(task is added to front of queue)
    then(output indicates priority position)

  when(user runs `khlone ask "interrupt me" --when disrupt`)
    then(current task is paused)
    then(new ask task runs immediately)
```

## usecase.4 = observation modes

```
given(clone is active)
  when(user runs `khlone watch`)
    then(output streams clone progress)
    then(ctrl+c returns to shell)
    then(clone continues work)
      sothat(observation is passive)

  when(user runs `khlone act "task" --watch`)
    then(act task is queued)
    then(output streams clone progress)
    then(ctrl+c returns to shell)

given(clone is active)
  when(user runs `khlone talk`)
    then(user enters interactive session with clone)
    then(/exit returns to shell)
    then(queue pauses while in talk mode)
      sothat(conversation is focused)

  when(user runs `khlone ask "question" --talk`)
    then(ask task is queued)
    then(user enters interactive session)
```

## usecase.5 = block output

```
given(user wants output piped to file)
  when(user runs `khlone ask "summarize" --await >> summary.md`)
    then(shell blocks until task completes)
    then(output emits to stdout)
    then(output is captured in file)
      sothat(shell-native pipelines work)

  when(user runs `khlone act "generate report" --await`)
    then(shell blocks until task completes)
    then(final output emits to stdout)
```

## usecase.6 = status inspection

```
given(user in a feature branch worktree)
  when(user runs `khlone status`)
    then(output shows zone-level status)
    then(output shows active clones and progress)
    then(output shows queued tasks)
      sothat(smart defaults match context)

given(user in main branch worktree)
  when(user runs `khlone status`)
    then(output shows site-level status)
    then(output shows all zones in repo)

given(user outside any git repo)
  when(user runs `khlone status`)
    then(output shows orchestrator-level status)
    then(output shows all sites on machine)

given(user wants explicit scope)
  when(user runs `khlone status orchestrator`)
    then(output shows orchestrator-level status)

  when(user runs `khlone status --task task-abc-123`)
    then(output shows task details, mode, and artifacts)

  when(user runs `khlone status --who mechanic.1`)
    then(output shows clone details and queue)
```

## usecase.7 = resource enumeration

```
given(user wants to see resources)
  when(user runs `khlone list sites`)
    then(output shows all sites on machine)
    then(output shows zone counts and activity)

  when(user runs `khlone list zones`)
    then(output shows all zones in current site)
    then(output shows clone status per zone)

  when(user runs `khlone list crews`)
    then(output shows all clones in current zone)
    then(output shows role, brain, status, queue depth)

  when(user runs `khlone list tasks`)
    then(output shows all tasks in current zone)
    then(output shows mode, status, clone assignment, tokens)
```

## usecase.8 = clone address

> `--who [role][.n][@brain][++]` addresses clone identity — role, brain, and index — in a single token. brain defaults to hero brain if `@brain` is omitted. role defaults to hero role if omitted.

```
given(user wants specific clone by index)
  when(user runs `khlone act "task" --who mechanic.1`)
    then(act task is queued to mechanic.1)
    then(hero clone is bypassed)

  when(user runs `khlone act "task" --who mechanic.1@claude`)
    then(mechanic.1 is found)
    then(brain is asserted to match claude)
    then(if brain does not match → error)

given(user wants to force-enroll a new clone)
  when(user runs `khlone act "research" --who researcher++`)
    then(new researcher clone is enrolled on hero brain)
    then(act task is queued to new clone)
    then(output shows enroll confirmation)

  when(user runs `khlone act "research" --who researcher@kimi++`)
    then(new researcher clone is enrolled on kimi brain)
    then(act task is queued to new clone)

given(user wants a clone on a specific brain)
  when(user runs `khlone act "quick fix" --who @grok`)
    then(khlone finds or enrolls hero role clone on grok brain)
    then(act task is queued to that clone)
    then(hero clone on default brain is not affected)

  when(user runs `khlone act "task" --who researcher@kimi`)
    then(khlone finds or enrolls researcher clone on kimi brain)
    then(act task is queued to that clone)

given(hero brain is claude per khlone.yml)
  when(user runs `khlone act "task"`)
    then(brain alias "claude" is looked up in khlone.yml)
    then(alias yields brain slug for resolution by rhachet)
    then(task dispatches via brainCli.act())

  when(user runs `khlone ask "question"`)
    then(task dispatches via brainCli.ask())
      sothat(ask mode maps to BrainCli.ask = no mutation tools)

given(task completes)
  when(BrainCli returns BrainOutput)
    then(metrics are captured: tokens, cost, duration)
    then(episode and series refs are preserved for continuation)
      sothat(token and cost data come from the typed BrainCli contract)

given(role alias not defined in khlone.yml)
  when(user runs `khlone act "task" --who unknown++`)
    then(error indicates unknown role)
    then(error lists available roles)
      sothat(typos are caught)

given(brain alias not defined in khlone.yml)
  when(user runs `khlone act "task" --who @unknown`)
    then(error indicates unknown brain)
    then(error lists available brains from khlone.yml)

given(brain alias cli slug references a supplier without BrainCli)
  when(khlone attempts to load the brain)
    then(error indicates cli supplier lacks BrainCli support)
    then(error explains that clones require BrainCli, not BrainAtom)
    then(error lists cli slugs with BrainCli support)
      sothat(atom-only suppliers are caught at dispatch time)

given(--who specifies index + brain mismatch)
  when(user runs `khlone act "task" --who mechanic.1@kimi`)
    then(error indicates mechanic.1 is on claude, not kimi)
```

## usecase.9 = skill dispatch

```
given(hero clone knows skill review.architecture)
  when(user runs `khlone ask --skill review.architecture`)
    then(ask task is queued to hero clone)
    then(skill is invoked)

given(only researcher clone knows skill research.patterns)
  when(user runs `khlone ask --skill research.patterns`)
    then(researcher clone is enrolled)
    then(ask task is queued to researcher)
    then(output shows enroll and skill invocation)

given(multiple clones know skill code.review)
  when(user runs `khlone ask --skill code.review`)
    then(error indicates ambiguity)
    then(error lists clones that know the skill)
    then(error suggests --who to disambiguate)

given(no clone knows skill unknown.skill)
  when(user runs `khlone ask --skill unknown.skill`)
    then(error indicates skill not found)
    then(error lists available skills)
```

## usecase.10 = cross-zone dispatch

```
given(user in @main zone)
  when(user runs `khlone status --zone @feat/auth`)
    then(output shows status of @feat/auth zone)

  when(user runs `khlone act "fix bug" --zone @feat/auth`)
    then(act task is queued in @feat/auth zone)
    then(user stays in current directory)

  when(user runs `khlone list tasks --zone @feat/auth`)
    then(output shows tasks from @feat/auth)

given(zone does not exist)
  when(user runs `khlone act "task" --zone @nonexistent`)
    then(zone is created)
    then(hero clone is enrolled in new zone)
    then(task is queued)
```

## usecase.11 = cross-site dispatch

```
given(user in site ehmpathy/myrepo)
  when(user runs `khlone status --site ahbode/svc-jobs`)
    then(output shows status of ahbode/svc-jobs)

  when(user runs `khlone act "task" --zone svc-jobs@feat/invoice`)
    then(act task is queued in svc-jobs site, feat/invoice zone)
    then(user stays in current directory)

  when(user runs `khlone ask "question" --zone ahbode/svc-auth@main --await`)
    then(ask task runs in svc-auth site)
    then(output returns to current shell)

given(site not in orchestrator registry)
  when(user runs `khlone status --site unknown/repo`)
    then(error indicates site not found)
    then(error suggests how to register site)
```

## usecase.12 = crash recovery

```
given(clone crashes mid-task)
  when(khlone daemon detects crash via brainCli.terminal.onExit)
    then(only the crashed clone is affected)
    then(peer clones continue unaffected)
      sothat(clone crash isolation is enforced via separate brainCli handles per clone)
    then(daemon spawns fresh brainCli via rhachet with same BrainSeries ref)
    then(new brainCli resumes within same BrainSeries — new episode, same series)
    then(task resumes from checkpoint)
    then(user is not interrupted)
      sothat(work survives failures with session continuity)

given(user exits shell with tasks queued)
  when(user opens new shell)
    then(queue is preserved)
    then(clone continues work — daemon owns the brainCli, not the shell)
    then(`khlone status` shows progress)
      sothat(daemon persistence eliminates the need for tmux)
```

## usecase.13 = task artifacts

```
given(task completes)
  when(onStop hooks run)
    then(summary artifact is captured)
    then(complete artifact is captured)
    then(token count is recorded)

  when(user runs `khlone status --task task-abc-123`)
    then(output shows mode)
    then(output shows all artifacts)
    then(output shows token usage)
```

## usecase.14 = transcript access

```
given(clone has run tasks)
  when(user runs `khlone log`)
    then(output shows transcript)

  when(user runs `khlone log --who mechanic.1`)
    then(output shows transcript for mechanic.1)
```

---

## error experiences

```
given(not in a git repo and no --site flag)
  when(user runs `khlone act "task"`)
    then(error indicates not in a git repo)
    then(error suggests --site flag)

given(khlone.yml not found)
  when(user runs `khlone act "task"`)
    then(error indicates absent config)
    then(error suggests how to create khlone.yml)

given(invalid flag combination)
  when(user runs `khlone act "task" --watch --talk`)
    then(error indicates mutually exclusive flags)

given(invalid zone address format)
  when(user runs `khlone act "task" --zone "bad format"`)
    then(error indicates invalid format)
    then(error shows valid formats)

given(--who specifies brain alias with atom-only supplier)
  when(user runs `khlone act "task" --who @xai-grok`)
    then(error indicates cli supplier lacks BrainCli)
    then(error explains clones require BrainCli, not BrainAtom)
    then(error lists brain aliases with BrainCli support)

given(rhachet-brains-* supplier package not installed)
  when(khlone attempts to load BrainCli for a brain alias)
    then(error indicates supplier package not found)
    then(error shows which package to install)
```
