# block E: interactive talk

> drop into a clone's session for direct conversation. daemon boots brainCli to interact mode, relays raw terminal bytes between the user and the clone.

---

## read first

1. `./1.vision.md` — sections: "operation: talk" (interactive session, /exit returns), "daemon architecture" (brainCli handle ownership, boot modes)
2. `./2.1.criteria.blackbox.md` — usecase 4 (observe: talk — interactive session, /exit returns)
3. `./3.3.blueprint.v1.i1.md` — codepath 2.4 (observation modes: setTerminalToTalkWithClone, byte relay, boot to dispatch on exit)
4. `./3.4.blueprint.handoff.contract.braincli.z1.interactive-modes.v1.i1.md` — dispatch vs interact mode mechanics
5. `./3.4.blueprint.handoff.contract.braincli.z2.talk-mode.v1.i1.md` — talk mode byte relay requirements
6. `./3.3.blueprint.z1.ipc-message.v1.i1.md` — IPC message types: talk, talk-ready, talk-end, input, resize
7. `./3.5.decomposition.v1.i1.md` — block E section: what ships, boundaries, file count

---

## prerequisite

**blocks A and D must be complete.** the daemon, IPC, and clone address (`--who`) must work. talk mode needs to target a specific clone by address.

---

## scope

### what to build

**domain operations (1 prod, 1 test):**
- setTerminalToTalkWithClone — connect to daemon via IPC, send `talk` message with clone slug, enter raw terminal mode, relay bytes bidirectionally, restore terminal on exit

**IPC messages to add:**
- `talk` — cli → daemon: request interactive session for a clone
- `talk-ready` — daemon → cli: brainCli booted to interact mode, byte relay started
- `talk-end` — daemon → cli: session ended (brain CLI exit or detach), includes exit reason and code
- `input` — cli → daemon: raw terminal bytes from the human's keyboard
- `resize` — cli → daemon: terminal size changed (SIGWINCH proxy), forward to brainCli.terminal.resize()

**daemon enhancements:**
- on `talk` message: call `brainCli.executor.boot({ mode: 'interact' })`, begin raw byte relay between IPC client and brainCli handle
- on brain CLI exit or CLI disconnect: call `brainCli.executor.boot({ mode: 'dispatch' })` to return clone to headless mode
- send `talk-ready` to cli once interact mode is ready
- send `talk-end` to cli when session ends

**cli (0 new files — extend extant):**
- `invokeTalk` already declared in block A's cli — implement the body
- add `--talk` flag support to extant invokeAsk/invokeAct
- on `--talk`: dispatch task, then enter talk mode with the target clone

**acceptance (1 test):**
- khlone.talk — enter interactive session, type input, see output, /exit returns, clone resumes dispatch mode

### the byte relay model

talk mode is a raw terminal bridge. the daemon is the relay — it owns the brainCli handle and mediates all bytes:

```
human terminal ←→ khlone CLI ←→ IPC (unix socket) ←→ daemon ←→ brainCli handle
```

1. cli sends `talk { cloneSlug }` via IPC
2. daemon calls `brainCli.executor.boot({ mode: 'interact' })`
3. daemon sends `talk-ready` to cli
4. cli sets `process.stdin` to raw mode (no echo, no line buffer)
5. human keystrokes → cli → IPC `input` → daemon → `brainCli.terminal.write(data)`
6. brainCli.terminal.onData → daemon → IPC `output` → cli → `process.stdout`
7. terminal resize → cli → IPC `resize` → daemon → `brainCli.terminal.resize(cols, rows)`
8. brain CLI exits or cli disconnects → daemon sends `talk-end` → cli restores terminal
9. daemon calls `brainCli.executor.boot({ mode: 'dispatch' })` — clone returns to headless mode

### what NOT to build

- **no remote talk.** cross-zone talk deferred to block G.
- **no persistence of talk sessions.** transcript capture deferred to block F.

---

## file count

| layer | prod | test | total |
|-------|------|------|-------|
| domain.operations (observe — talk) | 1 | 1 | 2 |
| acceptance (talk) | 0 | 1 | 1 |
| **total** | **1** | **2** | **3** |

---

## usecases fulfilled

| usecase | status |
|---------|--------|
| usecase.4: observe (talk) | **yes** — interactive session, /exit returns to shell |

---

## playtests

```sh
$ khlone talk
# drops into foreman.1's session (hero default)

$ khlone talk mechanic.1
# drops into mechanic.1's session

$ khlone act "implement auth" --talk
✓ task-pqr-678 → foreman.1
# drops into interactive session with foreman.1

# type commands, see output in real time
# /exit returns to shell
# daemon boots brainCli to dispatch mode
# clone resumes headless task execution
```

---

## done when

- [ ] `khlone talk` enters interactive session with hero clone
- [ ] `khlone talk mechanic.1` enters interactive session with specific clone
- [ ] `khlone act "task" --talk` dispatches task then enters interactive session
- [ ] raw terminal mode: keystrokes relay to brainCli without echo or buffer
- [ ] brainCli output relays to terminal in real time
- [ ] terminal resize proxies to brainCli via SIGWINCH → IPC resize
- [ ] /exit (or brain CLI exit) returns to shell and restores terminal state
- [ ] daemon boots brainCli to dispatch mode after talk session ends
- [ ] acceptance test: enter talk, type input, see output, exit, verify clone resumes dispatch
