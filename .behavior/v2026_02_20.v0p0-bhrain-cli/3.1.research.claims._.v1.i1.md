# block 0: BrainCli — claims research

> facts, assumptions, questions, and opinions relevant to the BrainCli contract + claude supplier

---

## citation index

| # | source | url |
|---|--------|-----|
| 1 | claude code CLI reference | https://code.claude.com/docs/en/cli-reference |
| 2 | claude code headless docs | https://code.claude.com/docs/en/headless |
| 3 | claude agent SDK overview | https://platform.claude.com/docs/en/agent-sdk/overview |
| 4 | claude agent SDK npm | https://www.npmjs.com/package/@anthropic-ai/claude-agent-sdk |
| 5 | claude agent SDK stream docs | https://platform.claude.com/docs/en/agent-sdk/stream-output |
| 6 | stream-json hang bug #25629 | https://github.com/anthropics/claude-code/issues/25629 |
| 7 | result event bug #1920 | https://github.com/anthropics/claude-code/issues/1920 |
| 8 | feb 2026 release notes | https://releasebot.io/updates/anthropic/claude-code |
| 9 | node-pty github | https://github.com/microsoft/node-pty |
| 10 | node-pty npm | https://www.npmjs.com/package/node-pty |
| 11 | @lydell/node-pty npm | https://www.npmjs.com/package/@lydell/node-pty |
| 12 | claude code permissions docs | https://code.claude.com/docs/en/permissions |
| 13 | claude code allowed tools guide | https://www.instructa.ai/blog/claude-code/how-to-use-allowed-tools-in-claude-code |
| 14 | allowedTools bypass bug #12232 | https://github.com/anthropics/claude-code/issues/12232 |
| 15 | claude code tools reference | https://www.vtrivedy.com/posts/claudecode-tools-reference |
| 16 | claude code sandbox docs | https://code.claude.com/docs/en/sandbox |
| 17 | 8 claude code exploits (flatt.tech) | https://flatt.tech/research/posts/pwn-claude-code-in-8-ways/ |
| 18 | claude code security docs | https://code.claude.com/docs/en/security |
| 19 | claude code common workflows | https://code.claude.com/docs/en/common-workflows |
| 20 | claude code --resume FAQ | https://claudelog.com/faqs/what-is-resume-flag-in-claude-code/ |
| 21 | session management guide | https://stevekinney.com/courses/ai-development/claude-code-session-management |
| 22 | session history lost bug #12114 | https://github.com/anthropics/claude-code/issues/12114 |
| 23 | config corruption bug #15608 | https://github.com/anthropics/claude-code/issues/15608 |
| 24 | severe corruption bug #18998 | https://github.com/anthropics/claude-code/issues/18998 |
| 25 | large session file freeze #21022 | https://github.com/anthropics/claude-code/issues/21022 |
| 26 | stdin consumed by shell detection #12507 | https://github.com/anthropics/claude-code/issues/12507 |
| 27 | raw mode error with piped stdin #1072 | https://github.com/anthropics/claude-code/issues/1072 |
| 28 | stdin hang with /dev/stdin #16306 | https://github.com/anthropics/claude-code/issues/16306 |
| 29 | ccusage github | https://github.com/ryoppippi/ccusage |
| 30 | goccc github | https://github.com/backstabslash/goccc |
| 31 | claude agent SDK cost docs | https://platform.claude.com/docs/en/agent-sdk/cost-track |
| 32 | claude API price guide (feb 2026) | https://costgoat.com/pricing/claude-api |
| 33 | claude API cache price tiers | https://platform.claude.com/docs/en/about-claude/pricing |
| 34 | opus 4.6 price guide | https://blog.laozhang.ai/en/posts/claude-opus-4-6-price-subscription-guide |
| 35 | SIGTERM graceful termination | https://komodor.com/learn/sigterm-signal-15-exit-code-143-linux-graceful-termination/ |
| 36 | docker stop grace period | https://www.suse.com/c/observability-sigkill-vs-sigterm/ |
| 37 | zombie processes in linux | https://linuxvox.com/blog/zombie-process-linux/ |
| 38 | orphan processes in linux | https://www.tutorialspoint.com/zombie-and-orphan-processes-in-linux |
| 39 | stream-json chain wiki | https://github.com/ruvnet/claude-flow/wiki/Stream-Chain |
| 40 | node-pty prebuilds PR #809 | https://github.com/microsoft/node-pty/pull/809 |
| 41 | cdktf child_process vs node-pty #3675 | https://github.com/hashicorp/terraform-cdk/issues/3675 |
| 42 | headless mode tutorial | https://www.claudecode101.com/en/tutorial/advanced/headless-mode |

---

## section 1: stream-json protocol

**claim 1** — [FACT] `--output-format stream-json` emits newline-delimited JSON with every token, turn, and tool interaction. [1]
> "output format for non-interactive mode (text, json, stream-json)"

**claim 2** — [FACT] stream-json enables real-time agent-to-agent output chain — one claude instance pipes nd-JSON to another. [39]
> "stream-json chain enables real-time agent-to-agent output pipe, seamless workflows where agents build upon each other's work without intermediate file storage"

**claim 3** — [FACT] the CLI hangs indefinitely after the final result event in stream-json mode — the process never exits cleanly. [6]
> "claude code CLI hangs indefinitely after successful task completion and the final result event, with the process never exited cleanly, and required manual SIGINT or SIGKILL to terminate"

**claim 4** — [FACT] the result event IS sent before the hang occurs — the hang is post-completion, not mid-execution. [6]
> "the result event IS sent (unlike some other issues where it's missed), but the hang occurs AFTER the result event"

**claim 5** — [SUMP] the supplier can implement a timeout after the result event to forcefully terminate the process if needed. [6]

**claim 6** — [FACT] a separate bug causes the final result event to be absent entirely after successful tool execution in stream-json mode. [7]
> "the CLI failed to send the required final result event in stream JSON mode after successful tool execution"

**claim 7** — [OPIN] stream-json lacks comprehensive official documentation — the format is inferred from behavior and community research, not from a formal spec. [1][39]

**claim 8** — [FACT] recent stability fixes (feb 2026) address stream, session preview, file handle, and several other issues. [8]
> "recent updates fix stream, session previews, file handle, and several stability issues"

---

## section 2: claude agent SDK vs CLI subprocess

**claim 9** — [FACT] the claude code SDK was renamed to "claude agent SDK" and is published as `@anthropic-ai/claude-agent-sdk`. [3]
> "SDK name change: the claude code SDK has been renamed to the claude agent SDK"

**claim 10** — [FACT] latest release: february 18, 2026 (npm version 0.2.47). [4]

**claim 11** — [FACT] the agent SDK exposes the same tools, agent loop, and context management that power claude code, programmable in TypeScript and Python. [3]
> "the agent SDK gives you the same tools, agent loop, and context management that power claude code"

**claim 12** — [FACT] the agent SDK runs in-process — no subprocess management, no IPC overhead, simpler deployment. [2]
> "no subprocess management — runs in the same process as your application, with better performance, no IPC overhead for tool calls"

**claim 13** — [OPIN] anthropic recommends the SDK over CLI for programmatic stream use. [5]
> "for programmatic stream with callbacks and message objects, the agent SDK is recommended over direct CLI integration"

**claim 14** — [FACT] headless mode (`claude -p`) is designed for non-interactive contexts like CI, pre-commit hooks, build automation. [42]
> "headless mode is a non-interactive mode designed for automation in contexts like CI/CD, pre-commit hooks, and build automation"

**claim 15** — [DECIDED] khlone will use the CLI subprocess, not the agent SDK. the CLI wraps the SDK with tools, prompts, behaviors, and the ability to use subscriptions (Claude Max). the SDK alone lacks these — it is a bare inference loop without the full claude code experience. CLI is the only viable path for v0.

**claim 16** — [FACT] with `--output-format stream-json`, all messages are JSON objects with a type field, emitted as nd-JSON, with message types: `system`, `assistant`, `user`, `result`, and `stream_event`. [2]
> "all messages are JSON objects with a type field, emitted as newline-delimited JSON (NDJSON)"

---

## section 3: node-pty reliability

**claim 17** — [FACT] node-pty is forked from pty.js with better support for later Node.js versions and Windows. maintained by Microsoft. [9]
> "node-pty is forked from chjj/pty.js with the primary goals of better support for later Node.js versions and Windows"

**claim 18** — [FACT] node-pty is not thread-safe — concurrent use across multiple worker threads can cause issues. [10]
> "node-pty is not thread safe so use across multiple worker threads in node.js could cause issues"

**claim 19** — [FACT] all processes launched from node-pty run at the same permission level of the parent process. recommend launch inside a container for server environments. [10]
> "all processes launched from node-pty will launch at the same permission level of the parent process"

**claim 20** — [FACT] `@lydell/node-pty` is a lighter-weight distribution that only installs prebuilt binaries for the current platform. [11]
> "@lydell/node-pty is a smaller distribution that only installs the prebuilt binaries needed for the current platform"

**claim 21** — [FACT] a recent PR enables load of native addons directly from prebuilds directory, which makes install more durable if the install step fails (e.g., with pnpm). [40]
> "enables load native addons directly from prebuilds directory, more durable if the install step fails or isn't run"

**claim 22** — [DECIDED] khlone will use `@lydell/node-pty` over `node-pty`. lydell's fork only installs prebuilt binaries for the current platform (smaller, more durable install). dispatch mode uses `child_process.spawn` with pipe stdio — no PTY needed. `@lydell/node-pty` is reserved for interact mode only.

**claim 23** — [FACT] terraform-cdk moved from node-pty to `node:child_process` to avoid native addon compilation issues and support Bun + Deno. [41]
> "invoke terraform CLI with node:child_process instead of node-pty (Bun + Deno support)"

---

## section 4: --allowedTools mode enforcement

**claim 24** — [FACT] allow rules let claude code use the specified tool without manual approval. deny rules prevent use entirely. [12]
> "allow rules let claude code use the specified tool without manual approval, deny rules prevent claude code from use of the specified tool"

**claim 25** — [FACT] out of the box, claude code has read-only access — it can look at files but cannot change or run commands without approval. [12]
> "out of the box, claude code is locked down with read-only access"

**claim 26** — [FACT] `--allowedTools` is ignored when combined with `--permission-mode bypassPermissions`. [14]
> "with --permission-mode bypassPermissions, --allowedTools appears to be ignored — set --allowedTools Read did not restrict the toolset"

**claim 27** — [SUMP] `--disallowedTools` works better than `--allowedTools` for restriction — it correctly blocks tools even in bypass mode. [14]

**claim 28** — [FACT] available tools include: Bash, Glob, Grep, LS, Read, Edit, MultiEdit, Write, NotebookRead, NotebookEdit, WebFetch, TodoRead, TodoWrite, WebSearch, exit_plan_mode. [15]
> "Bash, Glob, Grep, LS, exit_plan_mode, Read, Edit, MultiEdit, Write, NotebookRead, NotebookEdit, WebFetch, TodoRead, TodoWrite, and WebSearch"

**claim 29** — [FACT] read-only tools: Read, Glob, Grep, LS, WebFetch, WebSearch, TodoRead, NotebookRead. [13]
> "read-only operations: Read, Glob, Grep, LS, WebFetch and WebSearch"

**claim 30** — [FACT] write tools: Write, Edit, MultiEdit, NotebookEdit. [13]
> "write operations: Write, Edit, and MultiEdit"

**claim 31** — [FACT] claude code includes an intentional sandbox escape hatch — when a command fails due to sandbox restrictions, claude can retry with `dangerouslyDisableSandbox`. [16]
> "claude code includes an intentional escape hatch mechanism that allows commands to run outside the sandbox"

**claim 32** — [FACT] the escape hatch can be disabled via `allowUnsandboxedCommands: false` in sandbox settings. [16]
> "this escape hatch can be disabled by set allowUnsandboxedCommands: false"

**claim 33** — [FACT] security research found 8 ways to bypass claude code restrictions: ExitPlanMode escape, git abbreviation bypass, sed command execution, bash variable expansion, and more. [17]
> "use git with abbreviated arguments like --upload-pa can bypass claude code's blocklist mechanism"
> "the sed command with the e modifier can execute shell commands"
> "bash variable expansion syntax can be abused to execute arbitrary commands"

**claim 34** — [FACT] write operations are confined to the project scope — claude code cannot modify files in parent directories without explicit permission. [18]
> "claude code can only write to the folder where it was started and its subfolders"

**claim 35** — [KHUE] is `--allowedTools` sufficient for ask-mode read-only enforcement? given the known bypasses (claim 33), should khlone add additional guards (e.g., git diff post-check to verify no mutations)?

---

## section 5: session resume reliability

**claim 36** — [FACT] `--continue --print` resumes the most recent conversation in non-interactive mode. [19]
> "for automation, use claude --continue --print 'prompt' to resume in non-interactive mode"

**claim 37** — [FACT] resume preserves full message history — tool usage and results from the prior conversation are retained. [20]
> "the entire message history is restored to maintain context, tool usage and results from the previous conversation are preserved"

**claim 38** — [FACT] headless mode (`-p`) does not persist sessions by default. [42]
> "headless mode does not persist between sessions"

**claim 39** — [FACT] there is no CLI command to list session IDs — `--resume` only shows a fuzzy picker in interactive mode. the only way to find session UUIDs is to inspect `.jsonl` files in `~/.claude/projects/`. [21]
> "no CLI command to list session IDs — the only way to find session UUIDs is to manually inspect .jsonl files"

**claim 40** — [FACT] session history was lost after auto-update from 2.0.44 to 2.0.49 — history data present but not accessible, no format migration. [22]
> "users lost access to entire session history after auto-update, with history data present but not accessible"

**claim 41** — [FACT] `~/.claude.json` config file corrupts when multiple claude code processes access it at the same time. [23]
> "the ~/.claude.json config file becomes corrupted when multiple claude code CLI processes access it simultaneously"

**claim 42** — [FACT] in high-concurrency environments (30+ concurrent sessions), severe config corruption with 14+ occurrences in 11 hours. [24]
> "critical data loss in multi-project environments with high concurrency (30+ concurrent sessions)"

**claim 43** — [FACT] large session files (>50MB) cause claude code to become unresponsive with 90% RAM usage. [25]
> "claude code becomes completely unresponsive with 90% RAM usage with large .jsonl session transcript files"

**claim 44** — [DECIDED] khlone will run many clones per zone for v0. config contention is a **not-yet-a-problem** — user-validated at 10+ parallel processes without observed corruption. `CLAUDE_CONFIG_DIR` per clone is the fallback mitigation if contention ever surfaces. see zoomin: `.z1.multi-clone-contention`.

---

## section 6: stdin and process i/o concerns

**claim 45** — [FACT] claude code spawns child processes for shell environment detection that inherit stdin and consume it, which can cause the main process to receive EOF. [26]
> "shell detection subprocesses inherit stdin and consume it, so the main process receives EOF"

**claim 46** — [FACT] with piped stdin, the error "raw mode is not supported on the current process.stdin" can occur. [27]
> "the error 'raw mode is not supported on the current process.stdin' can occur with piped input"

**claim 47** — [FACT] the Bash tool can hang when it reads from `/dev/stdin` in sandbox mode. [28]
> "when the Bash tool reads from /dev/stdin in sandbox mode, claude code hangs after the command completes"

**claim 48** — [SUMP] dispatch mode (`-p --input-format stream-json`) avoids the raw mode error because it uses structured JSON protocol, not raw terminal input. but stdin consumption by shell detection (claim 45) may still affect the first read.

---

## section 7: process lifecycle

**claim 49** — [FACT] graceful shutdown: send SIGTERM first (request clean exit), then SIGKILL after a timeout for forced termination. [35]
> "process.terminate() sends a SIGTERM signal for graceful exit, and process.kill() sends a SIGKILL signal for immediate termination"

**claim 50** — [FACT] docker uses a 10-second grace period between SIGTERM and SIGKILL. [36]
> "docker waits for a grace period (default 10 seconds) for the process to exit, then sends a SIGKILL"

**claim 51** — [FACT] zombie processes retain their process table entry even after execution completes. the parent must call wait() or waitpid() to reap them. [37]
> "a zombie process is a process whose execution is completed but it still has an entry in the process table"

**claim 52** — [FACT] orphan processes (parent terminated first) are adopted by init (PID 1). [38]
> "orphan processes are adopted by init (PID 1)"

**claim 53** — [KHUE] should the BrainCli handle's kill() implementation use SIGTERM + 5s timeout + SIGKILL? or is a simpler SIGTERM-only approach sufficient for v0?

---

## section 8: cost and metrics

**claim 54** — [FACT] ccusage and goccc both extract cost data by parse of local JSONL session files — no real-time per-call cost API exists. [29][30]
> "ccusage is a CLI tool for analysis of claude code usage from local JSONL files"
> "goccc parses JSONL session logs, deduplicates stream responses, and calculates per-model API costs"

**claim 55** — [FACT] the claude agent SDK provides a cost service with service-level breakdowns in USD, with track of token usage, web search, and code execution costs. [31]

**claim 56** — [FACT] 2026 API rates: Sonnet at $3/$15 per million input/output tokens. Opus at $15/$75 per million tokens. [32]

**claim 57** — [FACT] cache multipliers: 5-minute cache write = 1.25x base input rate. 1-hour cache write = 2x base. cache read = 0.1x base. [33]
> "cache write tokens are 1.25 times the base input token rate, cache read tokens are 0.1 times the base input token rate"

**claim 58** — [FACT] opus 4.6 cached reads cost $0.50 per million tokens. cache write 1.25x, cache hit 0.1x base rate. [34]
> "cached reads cost $0.50 per million tokens"
> "cache write costs 1.25x base rate, but cache hits only cost 0.1x base rate"

**claim 59** — [SUMP] the BrainCli supplier can compute per-call cost from token counts in the stream events x model-specific rates. no session-file parse needed.

---

## section 9: CLI subprocess — the decided path

**claim 60** — [DECIDED] the CLI subprocess is the only viable path for v0. the CLI wraps the agent SDK with: (a) tools (Read, Edit, Bash, Grep, etc.), (b) system prompts and behavior, (c) subscription support (Claude Max plans — no per-token API cost), (d) permission enforcement, (e) CLAUDE.md and role context. the bare SDK lacks all of these — it is an inference loop, not the full claude code experience. [2][3]

**claim 61** — [CLOSED] moot — CLI is the decided path. the SDK question is settled.

**claim 62** — [CLOSED] moot — no hybrid approach. CLI subprocess for both dispatch and interact mode. dispatch via `-p --output-format stream-json`. interact via `--resume` in interactive TUI mode.

---

## summary of open questions

| # | question | status | impact |
|---|---|---|---|
| 15 | SDK vs CLI subprocess for v0? | **DECIDED: CLI** | CLI wraps SDK with tools, prompts, subscription support |
| 22 | `@lydell/node-pty` vs `node-pty`? | **DECIDED: lydell** | smaller install, prebuilt binaries, interact mode only |
| 35 | is `--allowedTools` sufficient for read-only enforcement? | OPEN | security of ask mode |
| 44 | multi-clone config corruption risk? | **DECIDED: not-yet-a-problem** | validated at 10+ parallel, `CLAUDE_CONFIG_DIR` as fallback (zoomin z1) |
| 53 | SIGTERM + timeout + SIGKILL or SIGTERM-only? | OPEN | kill() implementation |
| 61 | can the SDK support raw terminal attach? | **CLOSED** | moot — CLI is the decided path |
| 62 | hybrid SDK (dispatch) + CLI (interact)? | **CLOSED** | moot — CLI for both modes |

## companion zoomin research

| zoomin | slug | topic |
|---|---|---|
| z1 | multi-clone-contention | contention when many concurrent clones share `~/.claude/` state |
| z2 | session-file-ram | large session file growth and RAM exhaustion (includes TODO z2.29: prune session artifacts for long-lived brains — future work, not v0) |
