# block 0: BrainCli contract + claude supplier — roadmap

> ordered execution plan with dependencies, acceptance criteria, and verification at each step

---

## phase 0: scaffold + deps

**goal:** repo is ready to build — deps installed, directories created, types check clean

**read before start:**
- `.behavior/v2026_02_20.v0p0-bhrain-cli/3.3.blueprint.v1.i1.md` § 6 (dependencies)

**checklist:**
- [ ] install `@lydell/node-pty` as dev dep (pinned version)
- [ ] confirm `test-fns` is at 1.15.0+ (needs `genTempDir`)
- [ ] create `src/_topublish/rhachet/` directory
- [ ] create `src/_topublish/rhachet/__test__/` directory
- [ ] create `src/_topublish/rhachet-brains-anthropic/__test__/` directory (if absent)
- [ ] confirm `npm run test:types` passes with no new errors

**acceptance criteria:**
```
given the repo after phase 0
  when npm run test:types is executed
    then it passes with zero new errors
  when @lydell/node-pty is imported in a .ts file
    then it resolves without type errors
```

**verify:** `npm run test:types`

---

## phase 1: contract types

**goal:** the BrainCli interface and slug parse utility exist, are typed, and the slug parser is unit-tested

**depends on:** phase 0

**read before start:**
- `.behavior/v2026_02_20.v0p0-bhrain-cli/3.3.blueprint.v1.i1.md` § 1.1, 1.3, 1.4
- `.behavior/v2026_02_20.v0p0-bhrain-cli/3.1.research.domain._.v1.i1.md` § 2.1, 2.2 (BrainCli + BrainCliMode shapes)

**checklist:**
- [ ] create `src/_topublish/rhachet/BrainCli.ts` — interface type + BrainCliMode
- [ ] create `src/_topublish/rhachet/getOneSupplierSlugFromBrainSlug.ts` — pure text parse
- [ ] create `src/_topublish/rhachet/__test__/getOneSupplierSlugFromBrainSlug.test.ts` — data-driven caselist
- [ ] create `src/_topublish/rhachet/index.ts` — re-exports (BrainCli, BrainCliMode, genBrainCli placeholder)

**acceptance criteria:**
```
given a valid brain slug 'claude@anthropic/claude/opus/v4.5'
  when getOneSupplierSlugFromBrainSlug is called
    then it returns 'anthropic'

given a slug with no '@'
  when getOneSupplierSlugFromBrainSlug is called
    then it throws BadRequestError

given a slug with '@' but no '/' after the supplier
  when getOneSupplierSlugFromBrainSlug is called
    then it throws BadRequestError
```

**verify:** `npm run test:unit -- getOneSupplierSlugFromBrainSlug` + `npm run test:types`

---

## phase 2: supplier config

**goal:** the slug-to-config map exists with valid BrainSpec entries for each claude variant

**depends on:** phase 0

**read before start:**
- `.behavior/v2026_02_20.v0p0-bhrain-cli/3.3.blueprint.v1.i1.md` § 2.1
- `.behavior/v2026_02_20.v0p0-bhrain-cli/3.1.research.domain._.v1.i1.md` § 1.7 (BrainSpec shape), § 2.3-2.4 (slug + config types)

**checklist:**
- [ ] create `src/_topublish/rhachet-brains-anthropic/BrainCli.config.ts`
  - [ ] declare `AnthropicBrainCliSlug` type
  - [ ] declare `AnthropicBrainCliConfig` interface
  - [ ] declare `CONFIG_BY_CLI_SLUG` with entries for opus/v4.5 and sonnet/v4.5
  - [ ] populate BrainSpec cost rates per model (from rhachet types)
  - [ ] populate tools.ask and tools.act arrays per model

**acceptance criteria:**
```
given CONFIG_BY_CLI_SLUG
  when accessed with 'claude@anthropic/claude/opus/v4.5'
    then it returns a config with binary='claude', spec with cost rates, and ask/act tool arrays

given CONFIG_BY_CLI_SLUG
  when accessed with an invalid slug
    then it returns undefined
```

**verify:** `npm run test:types`

---

## phase 3: arg assembly

**goal:** dispatch and interact CLI args are computed deterministically and unit-tested

**depends on:** phase 2

**read before start:**
- `.behavior/v2026_02_20.v0p0-bhrain-cli/3.3.blueprint.v1.i1.md` § 2.2, 2.3
- `.behavior/v2026_02_20.v0p0-bhrain-cli/3.1.research.access._.v1.i1.md` (CLI flags and stream format)
- `.behavior/v2026_02_20.v0p0-bhrain-cli/3.1.research.claims._.v1.i1.md` (claim 35: --allowedTools enforcement)

**checklist:**
- [ ] create `src/_topublish/rhachet-brains-anthropic/getOneDispatchArgs.ts`
- [ ] create `src/_topublish/rhachet-brains-anthropic/getOneInteractArgs.ts`
- [ ] create `src/_topublish/rhachet-brains-anthropic/__test__/getOneDispatchArgs.test.ts` — data-driven caselist
- [ ] create `src/_topublish/rhachet-brains-anthropic/__test__/getOneInteractArgs.test.ts` — data-driven caselist

**acceptance criteria:**
```
given ask mode with no prior series
  when getOneDispatchArgs is called
    then args include: -p, --output-format stream-json, --input-format stream-json, --verbose
    then args include --allowedTools with read-only tools
    then args do NOT include --resume

given act mode with a prior series
  when getOneDispatchArgs is called
    then args include --allowedTools with full tool set
    then args include --resume <series.exid>

given no prior series
  when getOneInteractArgs is called
    then args is an empty array

given a prior series
  when getOneInteractArgs is called
    then args include --resume <series.exid>
```

**verify:** `npm run test:unit -- getOneDispatchArgs` + `npm run test:unit -- getOneInteractArgs`

---

## phase 4: stream parser

**goal:** nd-JSON event stream from claude `-p` is parsed into a typed BrainOutput with metrics — unit-tested with synthetic data

**depends on:** phase 2

**read before start:**
- `.behavior/v2026_02_20.v0p0-bhrain-cli/3.3.blueprint.v1.i1.md` § 2.4
- `.behavior/v2026_02_20.v0p0-bhrain-cli/3.1.research.access._.v1.i1.md` (nd-JSON event format, event types)
- `.behavior/v2026_02_20.v0p0-bhrain-cli/3.1.research.claims._.v1.i1.md` (claim z2.3: do not wait for process exit)
- `.behavior/v2026_02_20.v0p0-bhrain-cli/3.1.research.domain._.v1.i1.md` § 1.1-1.5 (BrainOutput, BrainOutputMetrics, BrainEpisode, BrainSeries, BrainExchange shapes)

**checklist:**
- [ ] create `src/_topublish/rhachet-brains-anthropic/getOneBrainOutputFromStreamJson.ts`
  - [ ] line-buffer stdout into complete JSON lines
  - [ ] parse by event type: message_start, content_block_start, content_block_delta, content_block_stop, message_delta, message_stop, error
  - [ ] accumulate text from content_block_delta (text_delta)
  - [ ] accumulate partial json from input_json_delta until content_block_stop
  - [ ] extract token counts from message_start (input) and message_delta (output, cache)
  - [ ] capture session_id for series construction
  - [ ] detect message_stop as completion (not process exit)
  - [ ] derive cost.cash from tokens x BrainSpec rates
  - [ ] construct BrainExchange, BrainEpisode, BrainSeries, BrainOutputMetrics, BrainOutput
- [ ] create `src/_topublish/rhachet-brains-anthropic/__test__/getOneBrainOutputFromStreamJson.test.ts`
  - [ ] test with synthetic nd-JSON stream: full happy path (message_start → deltas → message_delta → message_stop)
  - [ ] test token extraction (input > 0, output > 0)
  - [ ] test cost derivation (tokens x spec rates)
  - [ ] test series construction (session_id captured)
  - [ ] test text accumulation across multiple content_block_delta events
  - [ ] test error event throws with context

**acceptance criteria:**
```
given a synthetic nd-JSON stream with message_start, content_block_delta, message_delta, message_stop
  when getOneBrainOutputFromStreamJson is called
    then it returns a BrainOutput with non-empty output text
    then metrics.size.tokens.input > 0
    then metrics.size.tokens.output > 0
    then metrics.cost.time is a valid duration
    then episode is non-null with at least one exchange
    then series has an exid derived from session_id

given a synthetic nd-JSON stream with an error event
  when getOneBrainOutputFromStreamJson is called
    then it throws with the error context
```

**verify:** `npm run test:unit -- getOneBrainOutputFromStreamJson`

---

## phase 5: supplier factory

**goal:** the anthropic genBrainCli constructs a live BrainCli handle with all surfaces wired — ask, act, memory, executor, terminal

**depends on:** phase 1, phase 2, phase 3, phase 4

**read before start:**
- `.behavior/v2026_02_20.v0p0-bhrain-cli/3.3.blueprint.v1.i1.md` § 2.5 (full code sketch)
- `.behavior/v2026_02_20.v0p0-bhrain-cli/3.1.research.domain._.v1.i1.md` § 3.3 (handle operations table), § 5.1-5.4 (all flows)
- `.behavior/v2026_02_20.v0p0-bhrain-cli/3.1.research.claims._.v1.i1.md` (claim 35: tool mode enforcement, claim z2.3: message_stop completion)

**checklist:**
- [ ] create `src/_topublish/rhachet-brains-anthropic/genBrainCli.ts`
  - [ ] validate slug against CONFIG_BY_CLI_SLUG — throw BadRequestError if absent
  - [ ] declare mutable handle state: instance, series, lastTaskMode, childProcess, ptyProcess
  - [ ] declare event callback registries: dataListeners, exitListeners
  - [ ] implement wireTerminalHooks — wire stdout/exit to listener registries
  - [ ] implement handle.ask — guard dispatch mode, respawn on task mode change, write nd-JSON, parse stream, update series
  - [ ] implement handle.act — same as ask with act tool set
  - [ ] implement handle.memory — getter/setter for series
  - [ ] implement handle.executor.instance — getter
  - [ ] implement handle.executor.boot — kill extant, spawn dispatch (child_process) or interact (node-pty), update instance, wire hooks
  - [ ] implement handle.executor.kill — SIGTERM, set instance null, no-op if not booted
  - [ ] implement handle.terminal.write — dispatch: childProcess.stdin, interact: ptyProcess
  - [ ] implement handle.terminal.resize — interact: ptyProcess.resize, dispatch: no-op
  - [ ] implement handle.terminal.onData — push to dataListeners
  - [ ] implement handle.terminal.onExit — push to exitListeners

**acceptance criteria:**
```
given a valid anthropic slug
  when genBrainCli is called
    then it returns a BrainCli handle
    then handle.executor.instance is null
    then handle.memory.series is null

given an invalid slug not in CONFIG_BY_CLI_SLUG
  when genBrainCli is called
    then it throws BadRequestError
```

**verify:** `npm run test:types` (full integration tested in phase 7)

---

## phase 6: contract factory

**goal:** the contract-layer genBrainCli routes slugs to the correct supplier

**depends on:** phase 1, phase 5

**read before start:**
- `.behavior/v2026_02_20.v0p0-bhrain-cli/3.3.blueprint.v1.i1.md` § 1.2

**checklist:**
- [ ] create `src/_topublish/rhachet/genBrainCli.ts`
  - [ ] call getOneSupplierSlugFromBrainSlug to extract supplier
  - [ ] route 'anthropic' to dynamic import of supplier genBrainCli
  - [ ] throw BadRequestError for unrecognized suppliers
- [ ] update `src/_topublish/rhachet/index.ts` — export genBrainCli

**acceptance criteria:**
```
given a slug with supplier prefix 'anthropic'
  when contract genBrainCli is called
    then it delegates to the anthropic supplier and returns a BrainCli handle

given a slug with an unrecognized supplier prefix
  when contract genBrainCli is called
    then it throws BadRequestError with the invalid supplier in the message
```

**verify:** `npm run test:types` (full integration tested in phase 7)

---

## phase 7: supplier index

**goal:** the anthropic supplier package exports are wired

**depends on:** phase 5

**read before start:**
- `.behavior/v2026_02_20.v0p0-bhrain-cli/3.3.blueprint.v1.i1.md` § 2.6

**checklist:**
- [ ] update `src/_topublish/rhachet-brains-anthropic/index.ts` — add genBrainCli, CONFIG_BY_CLI_SLUG, type exports alongside extant hooks

**acceptance criteria:**
```
given the updated index.ts
  when imported from another module
    then genBrainCli, CONFIG_BY_CLI_SLUG, AnthropicBrainCliSlug, AnthropicBrainCliConfig are available
```

**verify:** `npm run test:types`

---

## phase 8: integration tests

**goal:** all 11 blackbox usecases are verified against a live claude code CLI process

**depends on:** phase 6, phase 7

**read before start:**
- `.behavior/v2026_02_20.v0p0-bhrain-cli/2.1.criteria.blackbox.md` (all 11 usecases — the source of truth for what to test)
- `.behavior/v2026_02_20.v0p0-bhrain-cli/3.3.blueprint.v1.i1.md` § 3.2 (integration test plan + notes)
- `.behavior/v2026_02_20.v0p0-bhrain-cli/3.1.research.domain._.v1.i1.md` § 1.1-1.5 (BrainOutput shape for assertions)

**checklist:**
- [ ] create `src/_topublish/rhachet-brains-anthropic/__test__/genBrainCli.integration.test.ts`
- [ ] use `genTempDir({ slug: 'braincli' })` from `test-fns` for the cwd
- [ ] test usecase.1: spawn handle from valid slug — instance=null, memory.series=null
- [ ] test usecase.1: invalid slug throws BadRequestError
- [ ] test usecase.2: boot dispatch — executor.instance is `{ pid: <number>, mode: 'dispatch' }`
- [ ] test usecase.3: ask returns BrainOutput — non-empty output, tokens > 0, series non-null
- [ ] test usecase.4: act returns BrainOutput — non-zero tokens
- [ ] test usecase.5: terminal.onData fires with chunks amid dispatch ask
- [ ] test usecase.5: terminal.onData fires with raw PTY bytes in interact mode
- [ ] test usecase.6: terminal.onExit fires exactly once on kill
- [ ] test usecase.7: kill is no-op when not booted (no error)
- [ ] test usecase.8: crash recovery — kill + reboot preserves series (same exid), new pid
- [ ] test usecase.9: mode switch — dispatch → interact preserves series, mode updated
- [ ] test usecase.10: terminal.write in dispatch mode writes to stdin without error
- [ ] test usecase.11: sequential ask calls — each BrainOutput has independent metrics (per-call, not cumulative)

**acceptance criteria:**
```
given a live claude binary with valid credentials
  when the full integration test suite runs
    then all usecase tests pass
    then token counts are > 0 for ask and act
    then series.exid is preserved across kill + reboot
    then series.exid is preserved across dispatch → interact mode switch
    then onExit fires exactly once per kill
    then sequential ask metrics are independent
```

**verify:** `npm run test:integration -- genBrainCli.integration`

---

## phase 9: final verification

**goal:** all tests pass, types check clean, no regressions

**depends on:** all prior phases

**checklist:**
- [ ] `npm run test:types` — zero errors
- [ ] `npm run test:unit` — all unit tests pass (slug parse, dispatch args, interact args, stream parser)
- [ ] `npm run test:integration -- genBrainCli.integration` — all integration tests pass
- [ ] review file inventory against blueprint filediff treestruct — confirm 10 prod (+1 updated) + 5 test = 16 files

**acceptance criteria:**
```
given the completed block 0 implementation
  when all test suites run
    then zero failures across unit, integration, and type checks
  when the file inventory is audited
    then it matches the blueprint filediff treestruct (16 files)
```

**verify:** `npm run test:types && npm run test:unit && npm run test:integration -- genBrainCli.integration`

---

## dependency graph

```
phase 0: scaffold + deps
├── phase 1: contract types (BrainCli.ts, slug parse + test)
│   ├── phase 6: contract factory (genBrainCli router)
│   └─┐
├── phase 2: supplier config (CONFIG_BY_CLI_SLUG)
│   ├── phase 3: arg assembly (dispatch + interact args + tests)
│   └── phase 4: stream parser (nd-JSON → BrainOutput + test)
│       └─┐
│         phase 5: supplier factory (anthropic genBrainCli)
│         ├── phase 7: supplier index (exports)
│         └── phase 6: contract factory
│             └── phase 8: integration tests (all 11 usecases)
│                 └── phase 9: final verification
```

**parallelizable:**
- phase 1 + phase 2 (no deps on each other)
- phase 3 + phase 4 (both depend on phase 2, independent of each other)

**critical path:** phase 0 → phase 2 → phase 4 → phase 5 → phase 8 → phase 9
