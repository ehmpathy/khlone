# block 0: BrainCli — audit gap report

> audit of implementation vs blueprint (`3.3.blueprint.v1.i1.md`) and blackbox criteria (`2.1.criteria.blackbox.md`)

---

## gap.1 = `--model` flag absent from dispatch args

**severity**: blocker (wrong model used at runtime)

**what**: `getOneDispatchArgs` does not pass `--model` to the claude CLI. the `BrainAtomConfig` has a `.model` field (e.g., `'claude-haiku-4-5-20251001'`, `'claude-opus-4-5-20251101'`) but it is never forwarded to the spawned process. all slugs — haiku, sonnet, opus — spawn with whatever default model the `claude` binary selects.

**where**: `src/_topublish/rhachet-brains-anthropic/getOneDispatchArgs.ts`

**evidence**: the args array contains `-p`, `--output-format`, `--input-format`, `--verbose`, `--allowedTools`, and optionally `--resume` — but no `--model`.

**fix**: add `'--model', input.config.model` to the args array. requires `AnthropicBrainCliConfig` to expose the `model` field from `BrainAtomConfig`, or pass the full atom config.

---

## gap.2 = `--model` flag absent from interact args

**severity**: blocker (same root cause as gap.1)

**what**: `getOneInteractArgs` also does not pass `--model`. interact mode should boot the correct model too.

**where**: `src/_topublish/rhachet-brains-anthropic/getOneInteractArgs.ts`

**fix**: same approach as gap.1 — add `--model` from config.

---

## gap.3 = `act()` has zero integration test coverage

**severity**: blocker (usecase 4 from blackbox criteria completely untested)

**what**: the integration test only exercises `ask()`. `act()` is never called against a live process. the criteria require:
- act returns BrainOutput with non-zero tokens
- act has access to mutation tools (Edit, Write, Bash)
- act on not-booted handle throws
- act on interact-mode handle throws

**where**: `src/_topublish/rhachet-brains-anthropic/__test__/genBrainCli.integration.test.ts`

**fix**: add `[t5]` or similar with `act({ prompt })` call, assert BrainOutput shape and metrics.

---

## gap.4 = interact mode boot has zero integration test coverage

**severity**: blocker (usecases 5-interact, 9, 10 from blackbox criteria untested)

**what**: no test boots a handle in interact mode. the criteria require:
- usecase 9: dispatch → interact preserves series; interact → dispatch preserves series
- usecase 5: terminal.onData fires with raw PTY bytes in interact mode
- usecase 10: terminal.write in interact mode relays to stdin

**where**: `src/_topublish/rhachet-brains-anthropic/__test__/genBrainCli.integration.test.ts`

**fix**: add test cases that boot interact, verify mode switch, and test terminal i/o.

---

## gap.5 = ask/act on interact-mode handle guard not tested

**severity**: caution (usecase 3/4 guard clause untested)

**what**: the blackbox criteria state: "given a BrainCli handle booted in interact mode, when ask/act is called, then it throws." this guard exists in prod code but is never exercised by a test.

**where**: `src/_topublish/rhachet-brains-anthropic/__test__/genBrainCli.integration.test.ts`

**fix**: add test: boot interact → call ask → expect throw. same for act.

---

## gap.6 = sequential metrics independence not tested

**severity**: caution (usecase 11 from blackbox criteria untested)

**what**: the criteria state: "given two sequential ask calls on the same handle, each BrainOutput has independent metrics (per-call, not cumulative), both > 0." no test exercises two consecutive dispatch calls on the same handle.

**where**: `src/_topublish/rhachet-brains-anthropic/__test__/genBrainCli.integration.test.ts`

**fix**: add test: boot → ask → ask → assert each BrainOutput has independent non-zero token counts.

---

## gap.7 = `AnthropicBrainCliConfig` lacks `model` field

**severity**: blocker (prerequisite for gap.1 and gap.2 fixes)

**what**: `AnthropicBrainCliConfig` has `{ slug, binary, spec, tools }` but no `model` field. the `BrainAtomConfig` from `rhachet-brains-anthropic` has `{ model, description, spec }`. the `model` field is lost in the `getOneConfig` helper which only extracts `.spec`.

**where**: `src/_topublish/rhachet-brains-anthropic/BrainCli.config.ts`

**fix**: add `model: string` to `AnthropicBrainCliConfig` and populate it from `CONFIG_BY_REPL_SLUG[replSlug].model` in `getOneConfig`.

---

## gap.8 = unit tests for dispatch/interact args don't assert `--model`

**severity**: caution (follows from gap.1/gap.2 — tests must cover model arg once added)

**what**: `getOneDispatchArgs.test.ts` and `getOneInteractArgs.test.ts` don't check for `--model` in output args. once the flag is added to prod code, tests must verify it.

**where**: `src/_topublish/rhachet-brains-anthropic/__test__/getOneDispatchArgs.test.ts`, `getOneInteractArgs.test.ts`

**fix**: add assertions for `--model` presence and correct value per config.

---

## summary

| # | gap | severity | scope |
|---|-----|----------|-------|
| 1 | `--model` absent from dispatch args | blocker | prod |
| 2 | `--model` absent from interact args | blocker | prod |
| 3 | `act()` not tested | blocker | test |
| 4 | interact mode not tested | blocker | test |
| 5 | ask/act on interact guard not tested | caution | test |
| 6 | sequential metrics not tested | caution | test |
| 7 | config lacks `model` field | blocker | prod |
| 8 | unit tests don't assert `--model` | caution | test |
